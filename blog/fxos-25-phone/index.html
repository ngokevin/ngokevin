<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhml"
      xmlns:fb="http://ogp.me/ns/fb#"
      xml:lang="en" lang="en">

  <head>
    <title>ngokevin | Building a Faster App Store for the FirefoxOS $25 Smartphone</title>
    <link rel="stylesheet" type="text/css" href="/css/bundle.css" />
    <link href='http://fonts.googleapis.com/css?family=Ubuntu:400,500,700' rel='stylesheet' type='text/css'>
    <link rel="icon" type="image/x-icon" href="/img/favicon.ico?v=5"/>
    <meta name="viewport" content="width=device-width">
    
  <link rel="stylesheet" type="text/css" href="/css/page.css" />
  
    <meta property="og:image" content="http://i.imgur.com/VfiQKPr.jpg"/>
  
  <meta property="og:description" content="For the last month and a half, I worked in a small team of about three other developers and two engineering managers to make our FirefoxOS app store, the Firefox Marketplace, fast and performant enough to run on our upcoming $25 smartphone. We were targetting a phone that would run on slower 2G connections, on lower memory, and with lower CPU. After an initial lessons-learned prototype that we did not end up shipping due to deadline pushes, we ended up forking our current app store into a separate project, Yogafire. This is how we made it fast. Make It a Packaged App Our current Marketplace that is running on phones around the world simply runs in an iframe within a packaged app. The decision around using an iframe was to: Have working Persona login due to CSP restrictions Have working Google Analytics due to CSP restrictions Keep the marketplace.firefox.com domain for apps that specify they can only be installed on that domain Instant updates However, the iframe method can be slow. Users at least on first launch of the app, have to download assets (our JS, CSS, templates, and data) over the air. Since then, we have worked around all of the issues blocking us from &#34;packaging&#34; the Marketplace. In a packaged app, assets are pre-loaded into the app to be shipped with phones; users then do not have to go out to the Content Delivery Network (CDN) to download assets. Pre-loading API Responses Normally the Marketplace would have to talk to our servers to get data such as apps to display on the storefront (actually, we cache API responses on the CDN too). But nevertheless, users still have to go out to the network to download necessary data. In the optimized app store, we have a suite of programs that download the API responses into JSON files that we package with the app to ship with the phones. Upon launch, the data from the JSON files are requested and pulled into our cache in the background. Multi-Layer Cache with Asynchronous Updating We implemented a multi-layer caching system: Data from pre-loaded JSON files are pulled into the localStorage cache All data is then subsequently requested from the cache Data requested from the cache is pulled into memory for subsequent requests The cache is asynchronously updated with the API Initially, we looked at using IndexedDB due to the lack of a 5MB storage cap that localStorage otherwise would have. However for our smaller data set, localStorage was marginally faster, and 5MB would be more than enough. In case the 5MB cap is ever hit, we simply wipe the cache. Still, on the lower-performance phone, localStorage still was not fast enough. So data that is pulled from localStorage is also stored into memory (RAM) in case the data is asked for again. This way, we get to keep the persistence of localStorage alongside the faster speed of memory. With asynchronous updating from the API, we never have to block on API requests, which would otherwise a dealbreaker on EDGE networks. Image Deferring Images, however, are by far the largest assets, which are mainly app icons and app screenshots. An average icon is about 4KB and an screenshot is about 20KB. These kilobytes add up. So we defer images. We have an image deferrer that constantly checks for images that scroll in the viewport, and if they do, only then do they load. Images outside the viewport are not loaded, saving bandwidth. Until then, we display a nice little Rocketship that waits for its queen image to be faded in. Note, we tried out pre-loading app icons and app screenshots into the package, but that bloated up the package too much. It would mean on every update we wanted to push out, users would have to download nearly a whole megabyte. No can do. We keep the package down to 200KB. Conclusion There were loads of other things we had to do such as implement a new design, optimize for languages such as Hindi and regions such as India, or improve offline usability. I entered the project about a fifth of the way through but quickly picked it up for a three-week sprint, Starting from Corvallis, Oregon and ending in Fort Myers, Florida. Since Mozilla is open and all, you can even check out our bug trackers: Version 0 Version 1 Version 1.1 In the end, we enjoyed some ice cream cake, and waited for the millions to pick up the phone. Funny thing is, I didn&#39;t even have the phone to develop on until I was done with the project!"/>

  </head>

  <body>
    <div id="wrap" class="c">
      <header>
        <div class="logos">
          <h1 id="logo">
            <a href='/'>ngo<strong>kevin</strong></a>
            <span class="social">
              <a href="mailto:me@ngokevin.com"><i class="fa fa-envelope"></i></a>
              <a href="http://twitter.com/andgokevin"><i class="fa fa-twitter-square"></i></a>
              <a href="http://github.com/ngokevin"><i class="fa fa-github-square"></i></a>
              <a type="application/rss+xml" href="/rss"><i class="fa fa-rss-square"></i></a>
            </span>
          </h1>
          <span id="sublogo">virtual reality developer at mozilla</span>
          <ul class="blog-tags">
            
              <li>
                <a href="/blog/tags/code/"
                   >
                  Code</a>
              </li>
            
              <li>
                <a href="/blog/tags/life/"
                   >
                  Life</a>
              </li>
            
              <li>
                <a href="/blog/tags/photography/"
                   >
                  Shoot</a>
              </li>
            
              <li>
                <a href="/blog/tags/poker/"
                   >
                  Poker</a>
              </li>
            
          </ul>
        </div>

        <nav>
          
            <a href="/about/">
              <span>
                About</span>
            </a>
          
            <a href="/">
              <span>
                Write</span>
            </a>
          
            <a href="/photography/">
              <span>
                Shoot</span>
            </a>
          
        </nav>
      </header>

      <div class="main">
        <div class="header-group">
  <div class="blog">
    <h1>Building a Faster App Store for the FirefoxOS $25 Smartphone</h1>

    <p class="metadata">
      
        Saturday June 07, 2014
      
    </p>
  </div>

  <div id="top-share" class="addthis_toolbox addthis_default_style">
  <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
  <a class="addthis_button_tweet"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-513af3cd5e69b4ae"></script>
</div>

        <div class="base-image">
          
            <div class="page_pic ">
              <img class="captioned" src="http://i.imgur.com/VfiQKPr.jpg">
              <div class="page-caption"><span>Would you rather have this $25 ice cream cake? Or this $25 phone?</span></div>
            </div>
          
        </div>

        
  <div class="page c">
    <p>For the last month and a half, I worked in a small team of about three other
developers and two engineering managers to make our FirefoxOS app store, the
<a href="http://marketplace.firefox.com">Firefox Marketplace</a>, fast and performant
enough to run on our upcoming <a href="http://www.cnet.com/news/with-firefox-os-mozilla-begins-the-25-smartphone-push/">$25
smartphone</a>.
We were targetting a phone that would run on slower 2G connections, on lower
memory, and with lower CPU. After an initial lessons-learned prototype that we
did not end up shipping due to deadline pushes, we ended up forking our current
app store into a separate project,
<a href="http://github.com/mozilla/yogafire">Yogafire</a>. This is how we made it fast.</p>
<h2 id="make-it-a-packaged-app">Make It a Packaged App</h2>
<p>Our current Marketplace that is running on phones around the world simply runs
in an iframe within a packaged app. The decision around using an iframe was to:</p>
<ul>
<li>Have working Persona login due to CSP restrictions</li>
<li>Have working Google Analytics due to CSP restrictions</li>
<li>Keep the <code>marketplace.firefox.com</code> domain for apps that specify they can only
  be installed on that domain</li>
<li>Instant updates</li>
</ul>
<p>However, the iframe method can be slow. Users at least on first launch of the
app, have to download assets (our JS, CSS, templates, and data) over the air.</p>
<p>Since then, we have worked around all of the issues blocking us from
"packaging" the Marketplace. In a packaged app, assets are pre-loaded into the
app to be shipped with phones; users then do not have to go out to the Content
Delivery Network (CDN) to download assets.</p>
<h2 id="pre-loading-api-responses">Pre-loading API Responses</h2>
<p>Normally the Marketplace would have to talk to our servers to get data such as
apps to display on the storefront (actually, we cache API responses on the CDN
too). But nevertheless, users still have to go out to the network to download
necessary data.</p>
<p>In the optimized app store, we have a <a href="https://github.com/mozilla/yogafire/tree/master/lib">suite of
programs</a> that download
the API responses into JSON files that we package with the app to ship with the
phones.  Upon launch, the data from the JSON files are requested and pulled
into our cache in the background.</p>
<h2 id="multi-layer-cache-with-asynchronous-updating">Multi-Layer Cache with Asynchronous Updating</h2>
<p>We implemented a <a href="https://github.com/mozilla/yogafire/blob/master/hearth/media/js/db.js">multi-layer caching
system</a>:</p>
<ul>
<li>Data from pre-loaded JSON files are pulled into the localStorage cache</li>
<li>All data is then subsequently requested from the cache</li>
<li>Data requested from the cache is pulled into memory for subsequent requests</li>
<li>The cache is asynchronously updated with the API</li>
</ul>
<p>Initially, we looked at using IndexedDB due to the lack of a 5MB storage cap
that localStorage otherwise would have. However for our smaller data set,
localStorage was marginally faster, and 5MB would be more than enough. In case
the 5MB cap is ever hit, we simply wipe the cache.</p>
<p>Still, on the lower-performance phone, localStorage still was not fast enough.
So data that is pulled from localStorage is also stored into memory (RAM) in
case the data is asked for again. This way, we get to keep the persistence of
localStorage alongside the faster speed of memory.</p>
<p>With asynchronous updating from the API, we never have to block on API
requests, which would otherwise a dealbreaker on EDGE networks.</p>
<h2 id="image-deferring">Image Deferring</h2>
<p>Images, however, are by far the largest assets, which are mainly app icons and
app screenshots. An average icon is about 4KB and an screenshot is about 20KB.
These kilobytes add up.</p>
<p>So we defer images. We have an <a href="https://github.com/mozilla/yogafire/blob/master/hearth/media/js/image-deferrer.js">image
deferrer</a>
that constantly checks for images that scroll in the viewport, and if they do,
only then do they load.  Images outside the viewport are not loaded, saving
bandwidth. Until then, we display a nice little Rocketship that waits for its
queen image to be faded in.</p>
<p>Note, we tried out pre-loading app icons and app screenshots into the package,
but that bloated up the package too much. It would mean on every update we
wanted to push out, users would have to download nearly a whole megabyte. No
can do. We keep the package down to 200KB.</p>
<h2 id="conclusion">Conclusion</h2>
<p>There were loads of other things we had to do such as implement a new design,
optimize for languages such as Hindi and regions such as India, or improve
offline usability. I entered the project about a fifth of the way through but
quickly picked it up for a three-week sprint, Starting from Corvallis, Oregon
and ending in Fort Myers, Florida.</p>
<p>Since Mozilla is open and all, you can even check out our bug trackers:</p>
<ul>
<li><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=998811">Version 0</a></li>
<li><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1000301">Version 1</a></li>
<li><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1011012">Version 1.1</a></li>
</ul>
<p>In the end, we enjoyed some ice cream cake, and waited for the millions to
pick up the phone. Funny thing is, I didn't even have the phone to develop
on until I was done with the project!</p>
<p><img alt="" src="http://i.imgur.com/3NNTjGK.png" /></p>
  </div>

  <p class="end-sect">&sect;</p>
  <div id="bottom-share" class="addthis_toolbox addthis_default_style">
  <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
  <a class="addthis_button_tweet"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-513af3cd5e69b4ae"></script>
   <div id="disqus_thread"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'ngokevin'; // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
           var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
           dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
           (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
  <script src="https://cdn.jsdelivr.net/anchorjs/3.0.0/anchor.min.js"></script>
  <script>anchors.add('h2, h3, h4, h5, h6');</script>

      </div>
    </div>

    <div id="footer">
      <a href="mailto:me@ngokevin.com"><i class="fa fa-envelope"></i></a>
      <a href="http://twitter.com/ngokevin_"><i class="fa fa-twitter-square"></i></a>
      <a href="http://github.com/ngokevin"><i class="fa fa-github-square"></i></a>
      <a type="application/rss+xml" href="/rss/index.xml"><i class="fa fa-rss-square"></i></a>
    </div>

     <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-29871909-1']);
  _gaq.push(['_trackPageview']);

  (function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
  </body>
</html>