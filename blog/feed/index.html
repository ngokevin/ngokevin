<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhml"
      xmlns:fb="http://ogp.me/ns/fb#"
      xml:lang="en" lang="en">

  <head>
    <title>ngokevin | Building the Marketplace Feed</title>
    <link rel="stylesheet" type="text/css" href="/css/bundle.css" />
    <link href='http://fonts.googleapis.com/css?family=Ubuntu:400,500,700' rel='stylesheet' type='text/css'>
    <link rel="icon" type="image/x-icon" href="/img/favicon.ico?v=5"/>
    <meta name="viewport" content="width=device-width">
    
  <link rel="stylesheet" type="text/css" href="/css/page.css" />
  
    <meta property="og:image" content="http://i.imgur.com/qS4jHbm.png"/>
  
  <meta property="og:description" content="The &#34;Feed&#34;, the new feature I spent the last three months grinding out for the Firefox Marketplace. The Feed transforms the FirefoxOS app store to provide an engaging and customized app discovery experience by presenting fresh user-tailored content on every visit. The concept was invented by Liu Liu, a Mozilla design intern I briefly hung out with last year. Well, it quickly gained traction by getting featured on Engadget, presented at the Mozilla Summit, and shown off on prototypes at Mobile World Congress. With more traction came more pressure to ship. We built that ship, and it sailed on time. Planning Phase The whole concept had a large scope so we broke it into four versions. For the first version, we focused on getting initial content pushing into the Feed. We planned to build a curation tool for our editorial team to control the content of the Feed, with the ability to tailor different content for different countries. Users would then be able to see fresh and new content on the homepage every day, thus increasing engagement. The final product for the Curation Tool, used by the editorial team to feature content and tailor different content for different countries. Some time was spent on the feature requirements and specifications as well as the visual design. We mainly had three engineers: myself, Chuck, and Davor. It was a slow start. Chuck started early on the technical architecture, building out some APIs and documentation. A few months later, I started work on the curation tool. My initial work was actually done off-the-grid in an RV in the middle of Alaska. But then the project to optimize the app for the $25 FirefoxOS smartphone took over. Once the air cleared, we all gathered for a work week hosted at Davor&#39;s place in Fort Myers, FL (since I was already in FL for a vacation). Building Phase In early June, we had a solid start during the work week with each of the three of us on working on separate components: Chuck on the backend API, Davor on the Feed visuals, me on the curation tools. The face-to-face over remote working was nice. I could ask any question that came to mind about unclear requirements, quickly ask for an API endpoint to be whipped up, or check on how the visuals were looking. After the foundations were in place, I transitioned to working on all parts of the feature from ElasticSearch, the API, the JS powering the curation tools and the Feed, to the CSS for the newer layout of the site. It was a fun grind for a couple of months just writing and refactoring tons of code, getting dirty with ElasticSearch, optimizing the backend. The launch date was set for late August. A couple of weeks out, the feature was there, but there were some bugs to iron out and tons of polish to be done. The most sketchy part was having no design mocks for desktop-sized screens so I had to improvise. The last week and a half was a sprint. I split my day up into 6 hours, a break to play some tournament poker at the poker club, and then 2 hours at night. Throw in a late Friday, and we made it to the finish line. Backend Bits The Feed needed to have an early focus on scalability. We should be able to add more and more factors (such as where they&#39;re from, what device they&#39;re using, apps they previously installed, content they &#34;loved&#34;) that tailor the Feed towards each user. ElasticSearch lets us easily dump a bunch of stuff into it, and we can do a quick query weighing in all of those factors. We cache the results behind a CDN, throw in couple of layers of client-side caching, and we got a stew going. Figuring out how to relate data between different indices was a difficult decision. I had several options in managing relations, but chose to manually denormalize the data and manage the relations myself. This allowed for flexibility and fine-tuned optimizations without having to wrestle with ElasticSearch under-the-hood. We had three indices to relate: Apps Feed Elements - an individual piece of the Feed such as a featured app or a collection of apps that can contain accompanying descriptions or images. Many-to-many relationship with Apps. Feed Items - a wrapper around Feed Elements containing metadata (region, category, carrier) that helps determine to whom the Feed Element should be displayed to. Many-to-many relationship with Feed Elements. This meant three ES queries overall (and 0 database queries). I used the new ElasticSearch Python DSL to help construct queries. Wrote a query (weighing all of the factors about a user) to fetch Feed Items, a query to fetch all of the Feed Elements to attach to the Feed Items, and a query to fetch all of the Apps to attach to the Feed Elements. We throw all of the data to our Django Rest Framework serializers to deserialize the final response. A complication was having to filter out apps, such as when an app is not public, or when an app is banned from the user&#39;s region, or when an app is not supported on the user&#39;s device. With time constraints, I wrote the filtering code in the view. But after the launch, I was able to consolidate our project&#39;s app filtering code into single query factory, use that, and tweak our serializers to handle filtered apps. Frontend Bits With the Feed being made of visual blocks and components, encapsulated template macros kept things clean. These reusable macros could be reused by our curation tools to display previews of the Feed on-the-fly for content curators. We used Isotope.js to arrange the layout of these visual blocks. Our CSS eventually turned messy, having everything being namespaced by the CSS class .feed, and falling under the trap of OOP-style CSS. A good style guide to follow in the future is @fat&#39;s CSS style guide for Medium. And since a lot of the code is shared between the frontend of the Firefox Marketplace and the curation tools, I&#39;m currently trying to get our reusable frontend assets managed under Bower. Conclusion The Feed is only going to grow in features. It&#39;s a breath of fresh air in comparison to what used to be a never-changing front page on the app store. I&#39;ve seen new apps I&#39;ve never even knew we had and some are actually fun like Astro Alpaca. Hope everyone likes it!"/>

  </head>

  <body>
    <div id="wrap" class="c">
      <header>
        <div class="logos">
          <h1 id="logo">
            <a href='/'>ngo<strong>kevin</strong></a>
            <span class="social">
              <a href="mailto:me@ngokevin.com"><i class="fa fa-envelope"></i></a>
              <a href="http://twitter.com/andgokevin"><i class="fa fa-twitter-square"></i></a>
              <a href="http://github.com/ngokevin"><i class="fa fa-github-square"></i></a>
              <a type="application/rss+xml" href="/rss"><i class="fa fa-rss-square"></i></a>
            </span>
          </h1>
          <span id="sublogo">virtual reality developer at mozilla</span>
          <ul class="blog-tags">
            
              <li>
                <a href="/blog/tags/code/"
                   >
                  Code</a>
              </li>
            
              <li>
                <a href="/blog/tags/life/"
                   >
                  Life</a>
              </li>
            
              <li>
                <a href="/blog/tags/photography/"
                   >
                  Shoot</a>
              </li>
            
              <li>
                <a href="/blog/tags/poker/"
                   >
                  Poker</a>
              </li>
            
          </ul>
        </div>

        <nav>
          
            <a href="/about/">
              <span>
                About</span>
            </a>
          
            <a href="/">
              <span>
                Write</span>
            </a>
          
            <a href="/photography/">
              <span>
                Shoot</span>
            </a>
          
        </nav>
      </header>

      <div class="main">
        <div class="header-group">
  <div class="blog">
    <h1>Building the Marketplace Feed</h1>

    <p class="metadata">
      
        Saturday September 20, 2014
      
    </p>
  </div>

  <div id="top-share" class="addthis_toolbox addthis_default_style">
  <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
  <a class="addthis_button_tweet"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-513af3cd5e69b4ae"></script>
</div>

        <div class="base-image">
          
            <div class="page_pic ">
              <img class="captioned" src="http://i.imgur.com/qS4jHbm.png">
              <div class="page-caption"><span>New front page of the Firefox Marketplace.</span></div>
            </div>
          
        </div>

        
  <div class="page c">
    <p>The "Feed", the new feature I spent the last three months grinding out for the
<a href="http://marketplace.firefox.com">Firefox Marketplace</a>. The Feed transforms the
FirefoxOS app store to provide an engaging and customized app discovery
experience by presenting fresh user-tailored content on every visit.  <a href="https://blog.mozilla.org/ux/2013/08/firefox-marketplace-in-the-future-customized-app-store-experience/">The
concept was invented by Liu Liu</a>, a Mozilla design intern I briefly hung
out with last year. Well, it quickly gained traction by getting <a href="http://www.engadget.com/2013/08/29/mozilla-marketplace-prototype/">featured on
Engadget</a>, presented at the Mozilla Summit, and shown off on
prototypes at Mobile World Congress. With more traction came more pressure to
ship. We built that ship, and it sailed on time.</p>
<h2 id="planning-phase">Planning Phase</h2>
<p>The whole concept had a large scope so we broke it into four versions. For the
first version, we focused on getting initial content pushing into the Feed. We
planned to build a <strong>curation tool</strong> for our editorial team to control the
content of the Feed, with the ability to tailor different content for different
countries. Users would then be able to see fresh and new content on the
homepage every day, thus increasing engagement.</p>
<p><img alt="Curation Tools" src="http://imgur.com/LGW9nXn.jpg" />
<div class="page-caption"><span>
The final product for the Curation Tool, used by the editorial team to feature
content and tailor different content for different countries.
</span></div></p>
<p>Some time was spent on the feature requirements and specifications as well as
the visual design. We mainly had three engineers: <a href="https://github.com/ngokevin">myself</a>,
<a href="https://github.com/chuckharmston">Chuck</a>, and <a href="https://github.com/spasovski">Davor</a>. It was a slow start. Chuck started early on
the technical architecture, building out some APIs and documentation. A few
months later, I started work on the curation tool. My initial work was actually
done off-the-grid <a href="http://imgur.com/LGW9nXn.jpg">in an RV in the middle of
Alaska</a>.</p>
<p>But then the project to <a href="/blog/fxos-25-phone/">optimize the app for the $25 FirefoxOS
smartphone</a> took over. Once the air cleared, we all
gathered for a work week hosted at Davor's place in Fort Myers, FL (since I was
already in FL for a vacation).</p>
<h2 id="building-phase">Building Phase</h2>
<p>In early June, we had a solid start during the work week with each of the three
of us on working on separate components: Chuck on the backend API, Davor on the
Feed visuals, me on the curation tools. The face-to-face over remote working
was nice. I could ask any question that came to mind about unclear
requirements, quickly ask for an API endpoint to be whipped up, or check on how
the visuals were looking.</p>
<p>After the foundations were in place, I transitioned to working on all parts of
the feature from ElasticSearch, the API, the JS powering the curation tools and
the Feed, to the CSS for the newer layout of the site. It was a fun grind for a
couple of months just writing and refactoring tons of code, getting dirty with
ElasticSearch, optimizing the backend.</p>
<p>The launch date was set for late August. A couple of weeks out, the feature was
there, but there were some bugs to iron out and tons of polish to be done. The
most sketchy part was having no design mocks for desktop-sized screens so I had
to improvise. The last week and a half was a sprint. I split my day up into 6
hours, a break to play some tournament poker at the poker club, and then 2
hours at night. Throw in a late Friday, and we made it to the finish line.</p>
<h2 id="backend-bits">Backend Bits</h2>
<p>The Feed needed to have an early focus on scalability. We should be able to add
more and more factors (such as where they're from, what device they're using,
apps they previously installed, content they "loved") that tailor the Feed
towards each user. ElasticSearch lets us easily dump a bunch of stuff into it,
and we can do a quick query weighing in all of those factors. We cache the
results behind a CDN, throw in couple of layers of client-side caching, and we
got a stew going.</p>
<p>Figuring out how to relate data between different indices was a difficult
decision. I had <a href="http://www.elasticsearch.org/blog/managing-relations-inside-elasticsearch/">several options in managing relations</a>, but chose
to manually denormalize the data and manage the relations myself. This allowed
for flexibility and fine-tuned optimizations without having to wrestle with
ElasticSearch under-the-hood. We had three indices to relate:</p>
<ul>
<li>Apps</li>
<li>Feed Elements - an individual piece of the Feed such as a featured app or a
collection of apps that can contain accompanying descriptions or images.
Many-to-many relationship with Apps.</li>
<li>Feed Items - a wrapper around Feed Elements containing metadata (region,
category, carrier) that helps determine to whom the Feed Element should be
displayed to. Many-to-many relationship with Feed Elements.</li>
</ul>
<p>This meant <a href="https://github.com/mozilla/zamboni/blob/02362de3e7b5d2d5e00e40deaeff8a959be0b42e/mkt/feed/views.py#L559">three ES queries overall</a> (and 0 database queries). I
used the new <a href="https://github.com/elasticsearch/elasticsearch-dsl-py/blob/master/docs/index.rst">ElasticSearch Python DSL</a> to help construct queries. Wrote
a query (weighing all of the factors about a user) to fetch Feed Items, a query
to fetch all of the Feed Elements to attach to the Feed Items, and a query to
fetch all of the Apps to attach to the Feed Elements. We throw all of the data
to our <a href="http://django-rest-framework.org/">Django Rest Framework</a> serializers to deserialize the final
response.</p>
<p>A complication was having to filter out apps, such as when an app is not
public, or when an app is banned from the user's region, or when an app is not
supported on the user's device. With time constraints, I wrote the filtering
code in the view. But after the launch, I was able to consolidate our project's
app filtering code into single query factory, use that, and tweak our
serializers to handle filtered apps.</p>
<h2 id="frontend-bits">Frontend Bits</h2>
<p>With the Feed being made of visual blocks and components, <a href="https://github.com/mozilla/fireplace/blob/05f39d1df726e46d9cb052d13502025758b2db30/src/templates/_macros/feed_item.html#L113">encapsulated
template macros</a> kept things clean. These reusable macros could be
reused by our curation tools to display previews of the Feed on-the-fly for
content curators.  We used Isotope.js to arrange the layout of these visual
blocks.</p>
<p>Our CSS eventually turned messy, having everything being namespaced by the CSS
class <em>.feed</em>, and falling under the trap of OOP-style CSS. A good style guide
to follow in the future is <a href="https://medium.com/@fat/mediums-css-is-actually-pretty-fucking-good-b8e2a6c78b06">@fat's CSS style guide for Medium</a>.</p>
<p>And since a lot of the code is shared between the frontend of the Firefox
Marketplace and the curation tools, I'm currently trying to get our reusable
frontend assets managed under Bower.</p>
<h2 id="conclusion">Conclusion</h2>
<p>The Feed is only going to grow in features. It's a breath of fresh air in
comparison to what used to be a never-changing front page on the app store.
I've seen new apps I've never even knew we had and some are actually fun like
<a href="https://marketplace.firefox.com/app/astroalpaca">Astro Alpaca</a>. Hope everyone
likes it!</p>
  </div>

  <p class="end-sect">&sect;</p>
  <div id="bottom-share" class="addthis_toolbox addthis_default_style">
  <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
  <a class="addthis_button_tweet"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-513af3cd5e69b4ae"></script>
   <div id="disqus_thread"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'ngokevin'; // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
           var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
           dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
           (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
  <script src="https://cdn.jsdelivr.net/anchorjs/3.0.0/anchor.min.js"></script>
  <script>anchors.add('h2, h3, h4, h5, h6');</script>

      </div>
    </div>

    <div id="footer">
      <a href="mailto:me@ngokevin.com"><i class="fa fa-envelope"></i></a>
      <a href="http://twitter.com/ngokevin_"><i class="fa fa-twitter-square"></i></a>
      <a href="http://github.com/ngokevin"><i class="fa fa-github-square"></i></a>
      <a type="application/rss+xml" href="/rss/index.xml"><i class="fa fa-rss-square"></i></a>
    </div>

     <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-29871909-1']);
  _gaq.push(['_trackPageview']);

  (function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
  </body>
</html>