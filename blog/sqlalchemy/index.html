<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhml"
      xmlns:fb="http://ogp.me/ns/fb#"
      xml:lang="en" lang="en">

  <head>
    <title>ngokevin | SQLAlchemy is Sorcery</title>
    <link rel="stylesheet" type="text/css" href="/css/bundle.css" />
    <link href='http://fonts.googleapis.com/css?family=Ubuntu:400,500,700' rel='stylesheet' type='text/css'>
    <link rel="icon" type="image/x-icon" href="/img/favicon.ico?v=5"/>
    <meta name="viewport" content="width=device-width">
    
  <link rel="stylesheet" type="text/css" href="/css/page.css" />
  
    <meta property="og:image" content="http://www.sqlalchemy.org/img/sqla-logo6.gif"/>
  
  <meta property="og:description" content="Recently at work, I had to populate a database table with contact information of network admins of secure VLANs behind firewall contexts. The information would be able to be viewed from Maintain, Oregon State&#39;s DNS/DHCP management web application. I first had to point Maintain towards a new table containing VLAN and firewall context pairings that was being populated programmatically whereas the current table containing VLAN information was populated manually. There was an issue. A subnet table was pointing to the current VLAN table by referencing its database ID. cue facepalm. The decade-old moldy codebase started to smell yet again. In order to point Maintain to the new table, I had to port the subnet table to point towards the VLAN ID rather than a database ID. I dread being a data entry monkey, so I set off to write a script to port the data. Since it involved handling a database, I figured this would be a good of a time as any to play with SQLAlchemy, an SQL ORM package for Python. How SQLAlchemy differs from the familiar Django ORM is SQLAlchemy&#39;s over-overwhelming amount of documentation and its concept of sessions. A session establishes all conversations with a database and acts as a &#34;holding zone&#34; for all objects loaded or associated with it during its lifespan. Essentially, it is sentient. A session can be binded to the database and tables can be mapped to objects like so: db = create_engine(DB_STRING, echo=False) session = sessionmaker(bind=db)() metadata = MetaData(db) subnet_table = Table(&#39;subnet&#39;, metadata, autoload=True) vlan_table = Table(&#39;vlan&#39;, metadata, autoload=True) # empty classes that db will be mapped to class Subnet(object): pass class Vlan(object): pass subnetmapper = mapper(Subnet, subnet_table) vlanmapper = mapper(Vlan, vlan_table) In my case, I wanted the subnet table to point at the vlan id field in the vlan table, not towards the database index. So I would query it like so: for subnet in session.query(Subnet).all(): vlan_db_id = subnet.vlan # get actual vlan id from the vlan db id in subnet field for vlan_result in session.query(Vlan).filter(Vlan.id==subnet.vlan): subnet.vlan = vlan_result.vlan_id break session.commit() In a way, it joins the subnet table to the vlan table. It changes the subnet&#39;s vlan id field and tells the session to commit it to the database. Note that Django&#39;s ORM is similar (object.save()), however there is no recollection of it after the operation. In SQLAlchemy, the session remembers all. I am sure there is a more compact way to implement this join given SQLAlchemy&#39;s immense querying API, but for a one-off script, it wasn&#39;t bad. I also wanted to write a script that would ameliorate the boredom of manual entry in populating the firewall contacts table. So I wrote another script that would ask for user input and enter data into the database through the command line which would be a bit faster than clicking around PHPMyAdmin. This was a bit more difficult. # get SECURE vlans that don&#39;t have ANY contact info print &#34;Getting secure VLANs that do not have ANY contact info for you to fill out&#34; exists_filter = exists().where(and_(Vlan.vlan_id==Contact.vlan_id, Vlan.context==Contact.context)) print &#34;%s of those VLANs found&#34; % (session.query(Vlan).filter(and_(Vlan.context!=&#39;&#39;, ~exists_filter)).count()) This grabs all of the secure VLANs that did not yet have any contact information filled out. Since it was populating an empty table, I had to check if a corresponding entry did not exist in the other table. To do this, I had to write a filter that checked that a corresponding entry DID exist, and later apply a NOT operator to get what I desired. for vlan in session.query(Vlan).filter(and_(Vlan.context!=&#39;&#39;, ~exists_filter)).order_by(&#39;context&#39;): if query_yes_no(&#34;No contact information found for %s[%s] on %s. Fill it out?&#34; % (vlan.name, vlan.vlan_id, vlan.context)): new_contact = Contact() new_contact.vlan_id = vlan.vlan_id new_contact.context = vlan.context new_contact.name = query(&#34; Contact name? &#34;) new_contact.email = query(&#34; Contact email? &#34;) new_contact.phone = query(&#34; Contact phone? &#34;) new_contact.department = query(&#34; Department? &#34;) session.add(new_contact) session.flush() Rather than updating information like before, this creates a new object in the database and adds it. Flushing the session sends the SQL to the database server. I ended up not using this script because I found a website on our intranet that contained contact information that I could scrape and enter into the database programatically. To do this, I used Beautiful Soup, which is brilliant, alongside SQLAlchemy. You can check out how I did that in a future blog post. SQLAlchemy is huge, and this was just the tip of the iceberg, but I simply highlighted how I pulled some basic usage out of it."/>

  </head>

  <body>
    <div id="wrap" class="c">
      <header>
        <div class="logos">
          <h1 id="logo">
            <a href='/'>ngo<strong>kevin</strong></a>
            <span class="social">
              <a href="mailto:me@ngokevin.com"><i class="fa fa-envelope"></i></a>
              <a href="http://twitter.com/andgokevin"><i class="fa fa-twitter-square"></i></a>
              <a href="http://github.com/ngokevin"><i class="fa fa-github-square"></i></a>
              <a type="application/rss+xml" href="/rss"><i class="fa fa-rss-square"></i></a>
            </span>
          </h1>
          <span id="sublogo">virtual reality developer at mozilla</span>
          <ul class="blog-tags">
            
              <li>
                <a href="/blog/tags/code/"
                   >
                  Code</a>
              </li>
            
              <li>
                <a href="/blog/tags/life/"
                   >
                  Life</a>
              </li>
            
              <li>
                <a href="/blog/tags/photography/"
                   >
                  Shoot</a>
              </li>
            
              <li>
                <a href="/blog/tags/poker/"
                   >
                  Poker</a>
              </li>
            
          </ul>
        </div>

        <nav>
          
            <a href="/about/">
              <span>
                About</span>
            </a>
          
            <a href="/">
              <span>
                Write</span>
            </a>
          
            <a href="/photography/">
              <span>
                Shoot</span>
            </a>
          
        </nav>
      </header>

      <div class="main">
        <div class="header-group">
  <div class="blog">
    <h1>SQLAlchemy is Sorcery</h1>

    <p class="metadata">
      
        Thursday December 15, 2011
      
    </p>
  </div>

  <div id="top-share" class="addthis_toolbox addthis_default_style">
  <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
  <a class="addthis_button_tweet"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-513af3cd5e69b4ae"></script>
</div>

        <div class="base-image">
          
            <div class="page_pic right">
              <img src="http://www.sqlalchemy.org/img/sqla-logo6.gif">
              
            </div>
          
        </div>

        
  <div class="page c">
    <p>Recently at work, I had to populate a database table with contact information
of network admins of secure VLANs behind firewall contexts. The information
would be able to be viewed from Maintain, Oregon State's DNS/DHCP management
web application. I first had to point Maintain towards a new table containing
VLAN and firewall context pairings that was being populated programmatically
whereas the current table containing VLAN information was populated manually.</p>
<p>There was an issue. A subnet table was pointing to the current VLAN table by
referencing its database ID. <em>cue facepalm</em>. The decade-old moldy codebase
started to smell yet again. In order to point Maintain to the new table, I had
to port the subnet table to point towards the VLAN ID rather than a database
ID. I dread being a data entry monkey, so I set off to write a script to port
the data. Since it involved handling a database, I figured this would be a good
of a time as any to play with <a href="http://sqlalchemy.org">SQLAlchemy</a>, an SQL ORM
package for Python.</p>
<p>How SQLAlchemy differs from the familiar Django ORM is SQLAlchemy's
over-overwhelming amount of documentation and its concept of sessions. A
session establishes all conversations with a database and acts as a "holding
zone" for all objects loaded or associated with it during its lifespan.
Essentially, it is sentient. A session can be binded to the database and tables
can be mapped to objects like so:</p>
<div class="highlight"><pre>db = create_engine(DB_STRING, echo=False)
session = sessionmaker(bind=db)()

metadata = MetaData(db)
subnet_table = Table(&#39;subnet&#39;, metadata, autoload=True)
vlan_table = Table(&#39;vlan&#39;, metadata, autoload=True)

# empty classes that db will be mapped to
class Subnet(object):
    pass
class Vlan(object):
    pass
subnetmapper = mapper(Subnet, subnet_table)
vlanmapper = mapper(Vlan, vlan_table)
</pre></div>


<p>In my case, I wanted the subnet table to point at the vlan id field in the vlan
table, not towards the database index. So I would query it like so:</p>
<div class="highlight"><pre>for subnet in session.query(Subnet).all():

    vlan_db_id = subnet.vlan

    # get actual vlan id from the vlan db id in subnet field
    for vlan_result in session.query(Vlan).filter(Vlan.id==subnet.vlan):
        subnet.vlan = vlan_result.vlan_id
        break

    session.commit()
</pre></div>


<p>In a way, it joins the subnet table to the vlan table. It changes the subnet's
vlan id field and tells the session to commit it to the database. Note that
Django's ORM is similar (object.save()), however there is no recollection of it
after the operation. In SQLAlchemy, the session remembers all.</p>
<p>I am sure there is a more compact way to implement this join given SQLAlchemy's
immense querying API, but for a one-off script, it wasn't bad. I also wanted to
write a script that would ameliorate the boredom of manual entry in populating
the firewall contacts table. So I wrote another script that would ask for user
input and enter data into the database through the command line which would be
a bit faster than clicking around PHPMyAdmin. This was a bit more difficult.</p>
<div class="highlight"><pre># get SECURE vlans that don&#39;t have ANY contact info
print &quot;Getting secure VLANs that do not have ANY contact info for you to fill out&quot;
exists_filter = exists().where(and_(Vlan.vlan_id==Contact.vlan_id, Vlan.context==Contact.context))

print &quot;%s of those VLANs found&quot; % (session.query(Vlan).filter(and_(Vlan.context!=&#39;&#39;, ~exists_filter)).count())
</pre></div>


<p>This grabs all of the secure VLANs that did not yet have any contact
information filled out. Since it was populating an empty table, I had to check
if a corresponding entry did not exist in the other table. To do this, I had to
write a filter that checked that a corresponding entry DID exist, and later
apply a NOT operator to get what I desired.</p>
<div class="highlight"><pre>for vlan in session.query(Vlan).filter(and_(Vlan.context!=&#39;&#39;, ~exists_filter)).order_by(&#39;context&#39;):

    if query_yes_no(&quot;No contact information found for %s[%s] on %s. Fill it out?&quot; % (vlan.name, vlan.vlan_id, vlan.context)):
        new_contact = Contact()
        new_contact.vlan_id = vlan.vlan_id
        new_contact.context = vlan.context

        new_contact.name = query(&quot;    Contact name? &quot;)
        new_contact.email = query(&quot;    Contact email? &quot;)
        new_contact.phone = query(&quot;    Contact phone? &quot;)
        new_contact.department = query(&quot;    Department? &quot;)
        session.add(new_contact)
        session.flush()
</pre></div>


<p>Rather than updating information like before, this creates a new object in the
database and adds it. Flushing the session sends the SQL to the database
server. I ended up not using this script because I found a website on our
intranet that contained contact information that I could scrape and enter into
the database programatically. To do this, I used Beautiful Soup, which is
brilliant, alongside SQLAlchemy. You can check out how I did that in a future
blog post. SQLAlchemy is huge, and this was just the tip of the iceberg, but I
simply highlighted how I pulled some basic usage out of it.</p>
  </div>

  <p class="end-sect">&sect;</p>
  <div id="bottom-share" class="addthis_toolbox addthis_default_style">
  <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
  <a class="addthis_button_tweet"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-513af3cd5e69b4ae"></script>
   <div id="disqus_thread"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'ngokevin'; // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
           var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
           dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
           (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
  <script src="https://cdn.jsdelivr.net/anchorjs/3.0.0/anchor.min.js"></script>
  <script>anchors.add('h2, h3, h4, h5, h6');</script>

      </div>
    </div>

    <div id="footer">
      <a href="mailto:me@ngokevin.com"><i class="fa fa-envelope"></i></a>
      <a href="http://twitter.com/ngokevin_"><i class="fa fa-twitter-square"></i></a>
      <a href="http://github.com/ngokevin"><i class="fa fa-github-square"></i></a>
      <a type="application/rss+xml" href="/rss/index.xml"><i class="fa fa-rss-square"></i></a>
    </div>

     <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-29871909-1']);
  _gaq.push(['_trackPageview']);

  (function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
  </body>
</html>